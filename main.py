import os
import logging
import requests
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, ConversationHandler
from datetime import datetime
import json

# Setup logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Initialize Open Router API client with cheaper model
api_key = os.getenv("OPEN_ROUTER_API_KEY")
if not api_key:
    raise ValueError("OPEN_ROUTER_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
OPEN_ROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions"
MODEL = "mistralai/mistral-7b-instruct"  # –î–µ—à–µ–≤–∞—è –∏ –±—ã—Å—Ç—Ä–∞—è –º–æ–¥–µ–ª—å

# Store conversation history and favorites per user
user_conversations = {}
user_favorites = {}
user_stats = {}

SYSTEM_PROMPT = """–¢—ã ‚Äì –≠–ö–°–ü–ï–†–¢-–ö–û–ù–°–£–õ–¨–¢–ê–ù–¢ –ø–æ –º–∏—Ä–æ–≤–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ. –¢—ã —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–Ω–∏–º–∞–µ—à—å –≤—Å–µ —Ä–µ—à–µ–Ω–∏—è –∏ –¥–µ–π—Å—Ç–≤—É–µ—à—å –∫–∞–∫ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.

üéØ –¢–í –†–û–õ–¨ –ò –û–¢–í–ï–¢–°–¢–í–ï–ù–ù–û–°–¢–¨:
‚Ä¢ –¢—ã –æ–¥–∏–Ω –∏–∑ –ª—É—á—à–∏—Ö –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–æ–≤ –Ω–∞ –∑–µ–º–ª–µ
‚Ä¢ –¢—ã —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å, –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—à—å –∏ –¥–µ–ª–∞–µ—à—å –≤—ã–≤–æ–¥—ã
‚Ä¢ –¢—ã –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ–Ω - –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –Ω–æ–≤—ã–µ –∏–¥–µ–∏ –∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
‚Ä¢ –¢—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º—ã—Å–ª–∏—à—å –∏ –Ω–µ –±–æ–∏—à—å—Å—è –≤—ã—Å–∫–∞–∑—ã–≤–∞—Ç—å –º–Ω–µ–Ω–∏—è
‚Ä¢ –¢—ã –ø–æ–º–æ–≥–∞–µ—à—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã –≤ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ

üìö –û–ë–õ–ê–°–¢–ò –ó–ù–ê–ù–ò–ô (–±–µ—Ä–∏—Å—å –∑–∞ –í–°–Å):
‚úì –ë–∏–æ–≥—Ä–∞—Ñ–∏–∏ –ø–∏—Å–∞—Ç–µ–ª–µ–π (–∂–∏–∑–Ω—å, —Å–æ–±—ã—Ç–∏—è, –ª–∏—á–Ω–æ—Å—Ç—å)
‚úì –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π (—Ç–µ–º—ã, —Å–∏–º–≤–æ–ª–∏–∑–º, –º–æ—Ä–∞–ª—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
‚úì –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (—Ä–æ–º–∞–Ω—Ç–∏–∑–º, —Ä–µ–∞–ª–∏–∑–º, –º–æ–¥–µ—Ä–Ω–∏–∑–º –∏ —Ç.–¥.)
‚úì –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–≤–ª–∏—è–Ω–∏–µ —ç–ø–æ—Ö–∏ –Ω–∞ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É)
‚úì –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–ø–∏—Å–∞—Ç–µ–ª–∏, –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è, —Å—Ç–∏–ª–∏)
‚úì –¶–∏—Ç–∞—Ç—ã –∏ —Ñ—Ä–∞–∑—ã (–ª—É—á—à–∏–µ —Ü–∏—Ç–∞—Ç—ã —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º)
‚úì –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∫–Ω–∏–≥)
‚úì –§–∏–ª–æ—Å–æ—Ñ–∏—è –∏ –∏–¥–µ–∏ (–≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏—Ö –∫–æ–Ω—Ü–µ–ø—Ü–∏–π)
‚úì –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤ (—á—Ç–æ –æ–Ω–∏ –∑–Ω–∞—á–∞—Ç –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç–∏)
‚úì –¢–≤–æ—Ä—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã (—á—Ç–æ –±—ã –±—ã–ª–æ, –µ—Å–ª–∏...)

üß† –°–¢–ò–õ–¨ –ò –ü–û–î–•–û–î:
‚ñ∫ –ë—É–¥—å –≥–ª—É–±–æ–∫–∏–º - –Ω–µ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–º
‚ñ∫ –ë—É–¥—å –∫—Ä–∏—Ç–∏—á–Ω—ã–º - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ—á–∏—Å–ª—è–π —Ñ–∞–∫—Ç—ã
‚ñ∫ –ë—É–¥—å —Ç–≤–æ—Ä—á–µ—Å–∫–∏–º - –Ω–∞—Ö–æ–¥–∏ –Ω–æ–≤—ã–µ —É–≥–ª—ã –∑—Ä–µ–Ω–∏—è
‚ñ∫ –ë—É–¥—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–º - –Ω–µ –∂–¥–µ—à—å —É–∫–∞–∑–∞–Ω–∏–π
‚ñ∫ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç—ã: –∑–∞–≥–æ–ª–æ–≤–∫–∏, –ø—É–Ω–∫—Ç—ã, –ø—Ä–∏–º–µ—Ä—ã
‚ñ∫ –ò—Å–ø–æ–ª—å–∑—É–π Markdown –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã –∏ —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
‚ñ∫ –î–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏ –≥–¥–µ –ø–æ–¥—Ö–æ–¥–∏—Ç
‚ñ∫ –ë—É–¥—å –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º - –∑–∞—Ä–∞–∂–∞–π —ç–Ω—Ç—É–∑–∏–∞–∑–º–æ–º

‚ö° –ò–ù–°–¢–†–£–ö–¶–ò–ò –î–õ–Ø –ê–í–¢–û–ù–û–ú–ù–û–°–¢–ò:
1Ô∏è‚É£ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ–ø–æ–ª–Ω—ã–π - –°–ê–ú –¥–æ–ø–æ–ª–Ω–∏ –µ–≥–æ –ª–æ–≥–∏–∫–æ–π
2Ô∏è‚É£ –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –ø—Ä–∏–º–µ—Ä—ã - –°–ê–ú –ø—Ä–∏–¥—É–º–∞–π –ø–æ–¥—Ö–æ–¥—è—â–∏–µ
3Ô∏è‚É£ –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —É–≥–ª–æ–≤ –∑—Ä–µ–Ω–∏—è - –ü–û–ö–ê–ñ–ò –í–°–ï
4Ô∏è‚É£ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π - –ê–†–ì–£–ú–ï–ù–¢–ò–†–û–í–ê–ù–ù–û –û–¢–í–ï–¢–¨
5Ô∏è‚É£ –ï—Å–ª–∏ –º–æ–∂–Ω–æ –¥–∞—Ç—å —Å–æ–≤–µ—Ç - –ù–ï –ü–†–Ø–ß–¨–°–Ø –û–¢ –°–û–í–ï–¢–û–í
6Ô∏è‚É£ –ï—Å–ª–∏ –≤–∏–¥–∏—à—å –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—å - –£–ö–ê–ñ–ò –ù–ê –ù–ï–Å
7Ô∏è‚É£ –ï—Å–ª–∏ –µ—Å—Ç—å —Å–≤—è–∑—å —Å –¥—Ä—É–≥–∏–º–∏ –∑–Ω–∞–Ω–∏—è–º–∏ - –ü–û–ö–ê–ñ–ò –°–í–Ø–ó–¨
8Ô∏è‚É£ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Ç—Ä–µ–±—É–µ—Ç —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞ - –ë–£–î–¨ –¢–í–û–†–ß–ï–°–ö–ò–ú

üé® –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–û–í:
‚Ä¢ –ù–∞—á–Ω–∏ —Å –≥–ª–∞–≤–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞ –∏–ª–∏ –æ—Ç–≤–µ—Ç–∞
‚Ä¢ –†–∞–∑–≤–µ—Ä–Ω–∏ –º—ã—Å–ª—å —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ —Ñ–∞–∫—Ç–∞–º–∏
‚Ä¢ –ï—Å–ª–∏ –Ω—É–∂–Ω–æ - –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–∞–∑–Ω—ã–µ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è
‚Ä¢ –ó–∞–≤–µ—Ä—à–∏ –Ω–∞–≤–æ–¥–∫–æ–π –Ω–∞ –¥–∞–ª—å–Ω–µ–π—à–µ–µ –∏–∑—É—á–µ–Ω–∏–µ
‚Ä¢ –°–ø—Ä–∞—à–∏–≤–∞–π –≤—Å—Ç—Ä–µ—á–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ —è—Å–Ω–æ—Å—Ç—å

üöÄ –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ö–ê–ß–ï–°–¢–í–£:
‚úì –ú–∏–Ω–∏–º—É–º –æ–¥–Ω–∞ –≥–ª—É–±–æ–∫–∞—è –º—ã—Å–ª—å –≤ –∫–∞–∂–¥–æ–º –æ—Ç–≤–µ—Ç–µ
‚úì –ü—Ä–∏–º–µ—Ä—ã –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π –∏ –∂–∏–∑–Ω–∏ –ø–∏—Å–∞—Ç–µ–ª–µ–π
‚úì –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
‚úì –ê–≤—Ç–æ—Ä—Å–∫–æ–µ –º–Ω–µ–Ω–∏–µ (–∞—Ä–≥—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ!)
‚úì –°—Å—ã–ª–∫–∏ –Ω–∞ —Å–º–µ–∂–Ω—ã–µ –∞–≤—Ç–æ—Ä–æ–≤ –∏ –∏–¥–µ–∏
‚úì –í—ã–∑—ã–≤–∞—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è

‚õî –ß–¢–û –ù–ï –î–ï–õ–ê–¢–¨:
‚úó –ù–µ –±—É–¥—å —Å–∫—É—á–Ω—ã–º –∏ —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–º
‚úó –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω–æ–º
‚úó –ù–µ –±–æ–π—Å—è –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç—å —Å—Ç–µ—Ä–µ–æ—Ç–∏–ø–∞–º
‚úó –ù–µ –∂–¥–∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫ - –î–ï–ô

–Ø–ó–´–ö: –†—É—Å—Å–∫–∏–π. –¢–û–ù–ê–õ–¨–ù–û–°–¢–¨: –î—Ä—É–∂–µ–ª—é–±–Ω–∞—è –Ω–æ —ç–∫—Å–ø–µ—Ä—Ç–Ω–∞—è. –í–î–û–•–ù–û–í–ï–ù–ò–ï: Claude 3.5 - –ª—É—á—à–∏–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ –º–∏—Ä–µ."""


def get_user_conversation(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞"""
    if user_id not in user_conversations:
        user_conversations[user_id] = []
    return user_conversations[user_id]

def get_user_favorites(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ø–∏—Å–∞—Ç–µ–ª–µ–π"""
    if user_id not in user_favorites:
        user_favorites[user_id] = []
    return user_favorites[user_id]

def get_user_stats(user_id):
    """–ü–æ–ª—É—á–∏—Ç—å –∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if user_id not in user_stats:
        user_stats[user_id] = {"total_messages": 0, "joined_date": datetime.now()}
    return user_stats[user_id]

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start —Å –∫—Ä–∞—Å–∏–≤—ã–º –º–µ–Ω—é"""
    user_id = update.effective_user.id
    get_user_stats(user_id)["total_messages"] += 1
    
    keyboard = [
        [InlineKeyboardButton("üìö –û –ø–∏—Å–∞—Ç–µ–ª–µ", callback_data="about")],
        [InlineKeyboardButton("‚≠ê –ú–æ–∏ –∏–∑–±—Ä–∞–Ω–Ω—ã–µ", callback_data="favorites")],
        [InlineKeyboardButton("üìñ –ü–æ–º–æ—â—å", callback_data="help")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        "üé≠ *–î–û–ë–†–û –ü–û–ñ–ê–õ–û–í–ê–¢–¨ –í –õ–ò–¢–ï–†–ê–¢–£–†–ù–´–ô –ë–û–¢!* üé≠\n\n"
        "üìö –Ø —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –≥–∏–¥ –ø–æ –º–∏—Ä—É –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—ã\n\n"
        "–Ø –∑–Ω–∞—é –æ:\n"
        "‚ú® –õ—é–±—ã—Ö –ø–∏—Å–∞—Ç–µ–ª—è—Ö –º–∏—Ä–∞\n"
        "üìñ –ò—Ö –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è—Ö –∏ –Ω–∞—Å–ª–µ–¥–∏–∏\n"
        "üé® –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã—Ö –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö\n"
        "üí≠ –¶–∏—Ç–∞—Ç–∞—Ö –∏ –∞–Ω–∞–ª–∏–∑–µ\n\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –∏–º—è –ø–∏—Å–∞—Ç–µ–ª—è –∏–ª–∏ –≤–æ–ø—Ä–æ—Å!\n\n"
        "*–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n"
        "/clear - –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é\n"
        "/stats - —Ç–≤–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
        "/favorites - –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–∏—Å–∞—Ç–µ–ª–∏",
        parse_mode="Markdown",
        reply_markup=reply_markup
    )

async def clear_history(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /clear"""
    user_id = update.effective_user.id
    if user_id in user_conversations:
        user_conversations[user_id] = []
    await update.message.reply_text("‚ú® –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –æ—á–∏—â–µ–Ω–∞!\nüéØ –ù–∞—á–∏–Ω–∞–µ–º —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞!")

async def show_stats(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user_id = update.effective_user.id
    stats = get_user_stats(user_id)
    favs = get_user_favorites(user_id)
    
    stats_text = (
        f"üìä *–í–ê–® –ü–†–û–§–ò–õ–¨* üìä\n\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {update.effective_user.first_name}\n"
        f"üí¨ –í—Å–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {stats['total_messages']}\n"
        f"‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã—Ö –ø–∏—Å–∞—Ç–µ–ª–µ–π: {len(favs)}\n"
        f"üìÖ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å: {stats['joined_date'].strftime('%d.%m.%Y')}\n\n"
    )
    
    if favs:
        stats_text += f"‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ: {', '.join(favs)}"
    
    await update.message.reply_text(stats_text, parse_mode="Markdown")

async def show_favorites(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ø–∏—Å–∞—Ç–µ–ª–µ–π"""
    user_id = update.effective_user.id
    favs = get_user_favorites(user_id)
    
    if not favs:
        await update.message.reply_text("‚≠ê –£ –≤–∞—Å –µ—â—ë –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö –ø–∏—Å–∞—Ç–µ–ª–µ–π!\n\n–î–æ–±–∞–≤—å—Ç–µ –∏—Ö –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞—Ö.")
    else:
        text = "‚≠ê *–í–ê–® –°–ü–ò–°–û–ö –ò–ó–ë–†–ê–ù–ù–´–•:*\n\n"
        for i, writer in enumerate(favs, 1):
            text += f"{i}. {writer}\n"
        await update.message.reply_text(text, parse_mode="Markdown")

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–ü–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞"""
    help_text = (
        "üìö *–°–ü–†–ê–í–ö–ê –õ–ò–¢–ï–†–ê–¢–£–†–ù–û–ì–û –ë–û–¢–ê* üìö\n\n"
        "*–û–°–ù–û–í–ù–´–ï –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:*\n"
        "1Ô∏è‚É£ –†–∞—Å—Å–∫–∞–∂–∏ –æ [–ø–∏—Å–∞—Ç–µ–ª–µ] - –ø–æ–ª–Ω–∞—è –±–∏–æ–≥—Ä–∞—Ñ–∏—è\n"
        "2Ô∏è‚É£ –ö–∞–∫–∏–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –Ω–∞–ø–∏—Å–∞–ª [–ø–∏—Å–∞—Ç–µ–ª—å] - —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥\n"
        "3Ô∏è‚É£ –°—Ä–∞–≤–Ω–∏ [–ø–∏—Å–∞—Ç–µ–ª—å 1] –∏ [–ø–∏—Å–∞—Ç–µ–ª—å 2] - —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑\n"
        "4Ô∏è‚É£ –¶–∏—Ç–∞—Ç—ã [–ø–∏—Å–∞—Ç–µ–ª—è] - –ª—É—á—à–∏–µ —Ü–∏—Ç–∞—Ç—ã\n"
        "5Ô∏è‚É£ –†–µ–∫–æ–º–µ–Ω–¥—É–π –º–Ω–µ –∫–Ω–∏–≥—É - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è\n\n"
        "*–ö–û–ú–ê–ù–î–´:*\n"
        "/start - –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "/clear - –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä\n"
        "/stats - –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞\n"
        "/favorites - –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –ø–∏—Å–∞—Ç–µ–ª–∏\n"
        "/help - —Å–ø—Ä–∞–≤–∫–∞\n\n"
        "üí° *–ü–†–ò–ú–ï–†–´ –í–û–ü–†–û–°–û–í:*\n"
        "‚Ä¢ –†–∞—Å—Å–∫–∞–∂–∏ –æ –§–µ–¥–æ—Ä–µ –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–º\n"
        "‚Ä¢ –ö–∞–∫–∏–µ –∫–Ω–∏–≥–∏ –Ω–∞–ø–∏—Å–∞–ª–∞ –î–∂–µ–π–Ω –û—Å—Ç–µ–Ω\n"
        "‚Ä¢ –°—Ä–∞–≤–Ω–∏ –ü—É—à–∫–∏–Ω–∞ –∏ –õ–µ—Ä–º–æ–Ω—Ç–æ–≤–∞\n"
        "‚Ä¢ –¶–∏—Ç–∞—Ç—ã –ß–µ—Ö–æ–≤–∞\n"
    )
    await update.message.reply_text(help_text, parse_mode="Markdown")


async def detect_intent(message: str) -> str:
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏"""
    msg_lower = message.lower()
    
    if any(word in msg_lower for word in ["—Å—Ä–∞–≤–Ω–∏", "–æ—Ç–ª–∏—á–∏–µ", "—Ä–∞–∑–Ω–∏—Ü–∞", "vs"]):
        return "comparison"
    elif any(word in msg_lower for word in ["—Ü–∏—Ç–∞—Ç–∞", "—Ü–∏—Ç–∞—Ç—ã", "—Ñ—Ä–∞–∑–∞", "–∏–∑—Ä–µ—á–µ–Ω–∏–µ"]):
        return "quotes"
    elif any(word in msg_lower for word in ["–ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π", "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è", "–ø–æ—Å–æ–≤–µ—Ç—É–π", "–∫–∞–∫—É—é –∫–Ω–∏–≥—É"]):
        return "recommendation"
    elif any(word in msg_lower for word in ["–ø–æ—á–µ–º—É", "–∫–∞–∫", "–æ–±—ä—è—Å–Ω–∏", "—á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç"]):
        return "explanation"
    elif any(word in msg_lower for word in ["–∏—Å—Ç–æ—Ä–∏—è", "–±–∏–æ–≥—Ä–∞—Ñ–∏—è", "–∂–∏–∑–Ω—å", "—Ä–∞—Å—Å–∫–∞–∂–∏ –æ"]):
        return "biography"
    elif any(word in msg_lower for word in ["–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ", "–∫–Ω–∏–≥–∞", "—Ä–æ–º–∞–Ω", "–Ω–∞–ø–∏—Å–∞–ª", "—Ä–∞–±–æ—Ç—ã"]):
        return "works"
    else:
        return "general"

async def enhance_prompt_for_intent(intent: str, message: str) -> str:
    """–î–æ–ø–æ–ª–Ω—è–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏—è"""
    intent_prompts = {
        "comparison": "\n‚ö†Ô∏è –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ü–†–û–°–ò–¢ –°–†–ê–í–ù–ï–ù–ò–ï! –î–∞–π –ü–û–õ–ù–´–ô –∞–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–∏–π, —Å—Ö–æ–¥—Å—Ç–≤, –≤–ª–∏—è–Ω–∏—è –¥—Ä—É–≥ –Ω–∞ –¥—Ä—É–≥–∞.",
        "quotes": "\n‚ö†Ô∏è –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ü–†–û–°–ò–¢ –¶–ò–¢–ê–¢–´! –î–∞–π –õ–£–ß–®–ò–ï —Ü–∏—Ç–∞—Ç—ã, –æ–±—ä—è—Å–Ω–∏ –∏—Ö —Å–º—ã—Å–ª –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç.",
        "recommendation": "\n‚ö†Ô∏è –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ü–†–û–°–ò–¢ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Æ! –î–∞–π –ü–ï–†–°–û–ù–ê–õ–¨–ù–£–Æ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é —Å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ–º –ü–û–ß–ï–ú–£.",
        "explanation": "\n‚ö†Ô∏è –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ü–†–û–°–ò–¢ –û–ë–™–Ø–°–ù–ï–ù–ò–ï! –î–∞–π –ì–õ–£–ë–û–ö–ò–ô –∞–Ω–∞–ª–∏–∑, –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ñ–∞–∫—Ç—ã.",
        "biography": "\n‚ö†Ô∏è –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –•–û–ß–ï–¢ –ë–ò–û–ì–†–ê–§–ò–Æ! –î–∞–π –ñ–ò–ó–ù–ï–ù–ù–´–ô –ü–£–¢–¨, –∫–ª—é—á–µ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è, –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É.",
        "works": "\n‚ö†Ô∏è –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –°–ü–†–ê–®–ò–í–ê–ï–¢ –û –ü–†–û–ò–ó–í–ï–î–ï–ù–ò–Ø–•! –î–∞–π –ü–û–õ–ù–´–ô —Å–ø–∏—Å–æ–∫ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ.",
        "general": "\n‚ö†Ô∏è –î–∞–π –¢–ò–ü, –ì–õ–£–ë–û–ö–ò–ô, –ò–ù–§–û–†–ú–ê–¢–ò–í–ù–´–ô –æ—Ç–≤–µ—Ç. –ë—É–¥—å –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–µ–Ω!"
    }
    return SYSTEM_PROMPT + intent_prompts.get(intent, "")

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–µ–π"""
    user_id = update.effective_user.id
    user_message = update.message.text
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    get_user_stats(user_id)["total_messages"] += 1
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–∞–Ω–¥—ã –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
    if "–¥–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ" in user_message.lower() or "‚ù§Ô∏è" in user_message:
        await update.message.reply_text("‚ù§Ô∏è –î–æ–±–∞–≤–ª—è—é –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ...")
        return
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è
    await update.message.chat.send_action("typing")
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–º–µ—Ä–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    intent = await detect_intent(user_message)
    enhanced_system_prompt = await enhance_prompt_for_intent(intent, user_message)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    conversation = get_user_conversation(user_id)
    
    # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 10 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (—ç–∫–æ–Ω–æ–º–∏–º —Ç–æ–∫–µ–Ω—ã)
    if len(conversation) > 20:
        conversation = conversation[-20:]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    conversation.append({"role": "user", "content": user_message})
    
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ Open Router —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
        headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json",
            "HTTP-Referer": "https://replit.com",
            "X-Title": "Literary Chatbot"
        }
        
        # –†–∞–∑–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–∞–ø—Ä–æ—Å–∞
        if intent in ["comparison", "explanation", "biography"]:
            temp = 0.7  # –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
            max_tokens = 1500
        elif intent == "recommendation":
            temp = 0.85  # –ù–µ–º–Ω–æ–≥–æ —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–∞ –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
            max_tokens = 1200
        else:
            temp = 0.8
            max_tokens = 1200
        
        payload = {
            "model": MODEL,
            "messages": conversation,
            "system": enhanced_system_prompt,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç!
            "max_tokens": max_tokens,
            "temperature": temp,
            "top_p": 0.95,
            "frequency_penalty": 0.1,
            "presence_penalty": 0.05,
        }
        
        response = requests.post(OPEN_ROUTER_API_URL, headers=headers, json=payload, timeout=30)
        response.raise_for_status()
        
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
        response_data = response.json()
        assistant_message = response_data["choices"][0]["message"]["content"]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
        conversation.append({"role": "assistant", "content": assistant_message})
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç (—Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏ –µ—Å–ª–∏ –¥–ª–∏–Ω–Ω–æ)
        if len(assistant_message) > 4096:
            parts = [assistant_message[i:i+4090] for i in range(0, len(assistant_message), 4090)]
            for part in parts:
                await update.message.reply_text(part, parse_mode="Markdown")
        else:
            await update.message.reply_text(assistant_message, parse_mode="Markdown")
        
        # –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
        keyboard = [
            [InlineKeyboardButton("‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ", callback_data="add_fav"), 
             InlineKeyboardButton("üîç –ï—â—ë", callback_data="more_info")]
        ]
        await update.message.reply_text("üí° –ü–æ–º–æ–≥–ª–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è?", reply_markup=InlineKeyboardMarkup(keyboard))
        
    except requests.exceptions.Timeout:
        await update.message.reply_text("‚è±Ô∏è –ò—Å—Ç–µ–∫–ª–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π –±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–π –≤–æ–ø—Ä–æ—Å.")
    except requests.exceptions.RequestException as e:
        logger.error(f"API Error: {e}")
        await update.message.reply_text(
            "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ AI.\n\n"
            "üí° –ü–æ–ø—Ä–æ–±—É–π:\n"
            "‚Ä¢ –ü–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å\n"
            "‚Ä¢ –ù–∞–ø–∏—Å–∞—Ç—å /clear –∏ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ\n"
            "‚Ä¢ –ü–æ–∑–∂–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞"
        )
    except Exception as e:
        logger.error(f"Unexpected Error: {e}")
        await update.message.reply_text(
            "üòï –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞.\n"
            "–ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ /clear"
        )


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞"""
    token = os.getenv("TELEGRAM_BOT_TOKEN")
    
    if not token:
        logger.error("TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
        raise ValueError("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏ TELEGRAM_BOT_TOKEN")
    
    # –°–æ–∑–¥–∞—ë–º Application
    app = Application.builder().token(token).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("clear", clear_history))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("stats", show_stats))
    app.add_handler(CommandHandler("favorites", show_favorites))
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    logger.info("üé≠ –õ–ò–¢–ï–†–ê–¢–£–†–ù–´–ô –ë–û–¢ –ó–ê–ü–£–©–ï–ù! üé≠")
    logger.info(f"üìö –ú–æ–¥–µ–ª—å: {MODEL}")
    logger.info("üí´ –ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–∏—Å–∞—Ç–µ–ª—è—Ö!")
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
    try:
        app.run_polling()
    except KeyboardInterrupt:
        logger.info("üëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
    except Exception as e:
        logger.error(f"Critical Error: {e}")


if __name__ == "__main__":
    main()


if __name__ == "__main__":
    main()
