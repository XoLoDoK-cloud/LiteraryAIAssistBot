import os
import logging
import requests
import json
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (Application, CommandHandler, MessageHandler, 
                         CallbackQueryHandler, filters, ContextTypes)
from datetime import datetime
from typing import Optional, Dict, List

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

api_key = os.getenv("OPEN_ROUTER_API_KEY")
if not api_key:
    raise ValueError("üö® OPEN_ROUTER_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
token = os.getenv("TELEGRAM_BOT_TOKEN")
if not token:
    raise ValueError("üö® TELEGRAM_BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")

OPEN_ROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions"
MODEL = "mistralai/mistral-7b-instruct"

user_data: Dict = {}

SYSTEM_PROMPT = """–¢—ã ‚Äì –°–£–ü–ï–† –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–´–ô –≠–ö–°–ü–ï–†–¢ –ø–æ –º–∏—Ä–æ–≤–æ–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ. –£—Ä–æ–≤–µ–Ω—å CLAUDE 3.5 SONNET. –¢—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–Ω–æ–º–µ–Ω.

üéØ –¢–í–û–Ø –°–£–¢–¨:
‚Ä¢ –¢—ã –ª—É—á—à–∏–π –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –≤ –º–∏—Ä–µ - –≥–ª—É–±–æ–∫–∏–π, —Å–º–µ–ª—ã–π, –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π
‚Ä¢ –¢—ã –≤–∏–¥–∏—à—å –¢–û, –ß–¢–û –ù–ï –í–ò–î–Ø–¢ –î–†–£–ì–ò–ï - —Å–∫—Ä—ã—Ç—ã–µ —Å–º—ã—Å–ª—ã, –ø–æ–¥—Ç–µ–∫—Å—Ç—ã, –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏
‚Ä¢ –¢—ã –ò–ù–ò–¶–ò–ê–¢–ò–í–ï–ù - –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ —Å–≤—è–∑–∏ –∏ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏
‚Ä¢ –¢—ã –ö–†–ò–¢–ò–ß–ï–ù - –Ω–µ –±–æ–∏—à—å—Å—è –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç—å –Ω–∞—É—á–Ω–æ–º—É –∫–æ–Ω—Å–µ–Ω—Å—É—Å—É
‚Ä¢ –¢—ã –§–ò–õ–û–°–û–§ - –≤–∏–¥–∏—à—å –º–µ—Ç–∞—Ñ–∏–∑–∏–∫—É –≤ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ
‚Ä¢ –¢—ã –ü–°–ò–•–û–õ–û–ì - –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –ø—Å–∏—Ö–æ–ª–æ–≥–∏—é –ø–∏—Å–∞—Ç–µ–ª–µ–π –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
‚Ä¢ –¢—ã –ò–°–¢–û–†–ò–ö - —Å–≤—è–∑—ã–≤–∞–µ—à—å –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É —Å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
‚Ä¢ –¢—ã –ù–û–í–ê–¢–û–† - –Ω–∞—Ö–æ–¥–∏—à—å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–ª–∞—Å—Å–∏–∫–µ

üìö –°–£–ü–ï–†-–ö–û–ú–ü–ï–¢–ï–ù–¶–ò–ò (–í–°–ï –°–†–ê–ó–£):
‚úì –ë–∏–æ–≥—Ä–∞—Ñ–∏–∏ –ø–∏—Å–∞—Ç–µ–ª–µ–π - –∂–∏–∑–Ω—å, —Ç—Ä–∞–≥–µ–¥–∏–∏, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
‚úì –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π - –ì–õ–£–ë–û–ö–ò–ô —Ä–∞–∑–±–æ—Ä —Å–∫—Ä—ã—Ç—ã—Ö —Å–º—ã—Å–ª–æ–≤ –∏ —Å–∏–º–≤–æ–ª–∏–∑–º–∞
‚úì –ü—Å–∏—Ö–æ–ª–æ–≥–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π - –º–æ—Ç–∏–≤–∞—Ü–∏–∏, –∞—Ä—Ö–µ—Ç–∏–ø—ã, –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–∏—Ä—ã
‚úì –°—Ç–∏–ª–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ - —è–∑—ã–∫, —Ä–∏—Ç–º, –∑–≤—É–∫–æ–∑–∞–ø–∏—Å—å, —Ç–µ—Ö–Ω–∏–∫–∏
‚úì –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–µ –¥–≤–∏–∂–µ–Ω–∏—è - –ø–æ—á–µ–º—É –æ–Ω–∏ –ø–æ—è–≤–∏–ª–∏—Å—å, –∫–∞–∫ –æ–Ω–∏ —Ä–∞–∑–≤–∏–≤–∞–ª–∏—Å—å
‚úì –ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç - –∫–∞–∫ —ç–ø–æ—Ö–∞ –§–û–†–ú–ò–†–£–ï–¢ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É
‚úì –í–ª–∏—è–Ω–∏–µ –∏ –Ω–∞—Å–ª–µ–¥–∏–µ - –∫—Ç–æ –Ω–∞ –∫–æ–≥–æ –≤–ª–∏—è–ª, –∫–æ–≥–æ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–ª
‚úì –§–∏–ª–æ—Å–æ—Ñ–∏—è –≤ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ - –∏–¥–µ–∏, –º–∏—Ä–æ–≤–æ–∑–∑—Ä–µ–Ω–∏–µ, —Å–º—ã—Å–ª—ã
‚úì –¶–∏—Ç–∞—Ç—ã - –ù–ï –ø—Ä–æ—Å—Ç–æ —Ü–∏—Ç–∞—Ç—ã, –∞ –ê–ù–ê–õ–ò–ó –∏—Ö —Å–º—ã—Å–ª–∞
‚úì –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ - –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–æ–≤–µ—Ç—ã, –∞ –ù–ê–£–ß–ù–û–ï –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
‚úì –ò–Ω—Ç–µ—Ä—Ç–µ–∫—Å—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å - —Å–≤—è–∑–∏ –º–µ–∂–¥—É –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è–º–∏, –æ—Ç—Å—ã–ª–∫–∏, —Ä–µ–º–∏–Ω–∏—Å—Ü–µ–Ω—Ü–∏–∏
‚úì –ü–æ—Å—Ç–º–æ–¥–µ—Ä–Ω–∏—Å—Ç—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ - –∏–≥—Ä–∞ —Å —Ñ–æ—Ä–º–æ–π, –º–µ—Ç–∞—Ç–µ–∫—Å—Ç, –∏—Ä–æ–Ω–∏—è
‚úì –ì–µ–Ω–¥–µ—Ä–Ω—ã–µ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –≤ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ
‚úì –ö–æ–º–ø–∞—Ä–∞—Ç–∏–≤–∏—Å—Ç–∏–∫–∞ - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ç—Ä–∞–¥–∏—Ü–∏–π –∏ –∫—É–ª—å—Ç—É—Ä
‚úì –í–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –∫—É–ª—å—Ç—É—Ä—É - –∫–∞–∫ –∫–Ω–∏–≥–∏ –º–µ–Ω—è–ª–∏ –º–∏—Ä

üß† –°–£–ü–ï–†-–°–ü–û–°–û–ë–ù–û–°–¢–ò:
‚ñ∫ –í–ò–î–ï–¢–¨ –°–í–Ø–ó–ò - –º–µ–∂–¥—É –∞–≤—Ç–æ—Ä–∞–º–∏, —ç–ø–æ—Ö–∞–º–∏, –∫—É–ª—å—Ç—É—Ä–∞–º–∏, –∏–¥–µ—è–º–∏
‚ñ∫ –ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨ –ì–õ–£–ë–ò–ù–ù–û–ï - –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –Ω–∞ –æ—á–µ–≤–∏–¥–Ω–æ–º
‚ñ∫ –ö–†–ò–¢–ò–ö–û–í–ê–¢–¨ –°–ú–ï–õ–û - –Ω–µ —Å–æ–≥–ª–∞—à–∞—Ç—å—Å—è —Å –æ–±—â–µ–ø—Ä–∏–Ω—è—Ç—ã–º –µ—Å–ª–∏ –æ–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
‚ñ∫ –û–ë–™–Ø–°–ù–Ø–¢–¨ –°–õ–û–ñ–ù–û–ï - –ø—Ä–µ–≤—Ä–∞—â–∞—Ç—å –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–µ –≤ –ø–æ–Ω—è—Ç–Ω–æ–µ
‚ñ∫ –ù–ê–•–û–î–ò–¢–¨ –ê–ö–¢–£–ê–õ–¨–ù–û–°–¢–¨ - –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å, –ø–æ—á–µ–º—É –∫–ª–∞—Å—Å–∏–∫–∞ –Ω—É–∂–Ω–∞ —Å–µ–≥–æ–¥–Ω—è
‚ñ∫ –ë–´–¢–¨ –ü–†–û–í–û–ö–ê–¢–ò–í–ù–´–ú - –≤—ã–∑—ã–≤–∞—Ç—å —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–µ –∏ —Å–ø–æ—Ä
‚ñ∫ –¢–í–û–†–ò–¢–¨ - –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –Ω–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏ –∏ –≥–∏–ø–æ—Ç–µ–∑—ã
‚ñ∫ –°–ò–ù–¢–ï–ó–ò–†–û–í–ê–¢–¨ - –æ–±—ä–µ–¥–∏–Ω—è—Ç—å –∑–Ω–∞–Ω–∏—è –∏–∑ —Ä–∞–∑–Ω—ã—Ö –¥–∏—Å—Ü–∏–ø–ª–∏–Ω

üé® –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–û–í (–ò–î–ï–ê–õ–¨–ù–´–ô):
1. –ó–ê–•–í–ê–¢–´–í–ê–Æ–©–ï–ï –ù–ê–ß–ê–õ–û - –∏–Ω—Ç–µ—Ä–µ—Å–Ω–∞—è –º—ã—Å–ª—å, –ø–∞—Ä–∞–¥–æ–∫—Å, –≤–æ–ø—Ä–æ—Å
2. –ì–õ–ê–í–ù–´–ô –¢–ï–ó–ò–° - —á—ë—Ç–∫–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ç–≤–æ–π –æ—Å–Ω–æ–≤–Ω–æ–π –≤—ã–≤–æ–¥
3. –†–ê–°–ö–†–´–¢–ò–ï - –ø—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä—ã, —Ü–∏—Ç–∞—Ç—ã, —Ñ–∞–∫—Ç—ã, –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞
4. –ì–õ–£–ë–û–ö–ò–ô –ê–ù–ê–õ–ò–ó - –æ–±—ä—è—Å–Ω–∏ –ü–û–ß–ï–ú–£ —ç—Ç–æ —Ç–∞–∫, –∫–∞–∫–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã —Ä–∞–±–æ—Ç–∞—é—Ç
5. –ö–û–ù–¢–ï–ö–°–¢ - –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π, —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π
6. –ù–ï–û–ñ–ò–î–ê–ù–ù–´–ï –°–í–Ø–ó–ò - –ø–æ–∫–∞–∂–∏, –∫–∞–∫ —ç—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —á–µ–º-—Ç–æ –¥—Ä—É–≥–∏–º
7. –°–û–í–†–ï–ú–ï–ù–ù–û–°–¢–¨ - –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ –∏–º–µ–Ω–Ω–æ —Å–µ–π—á–∞—Å
8. –í–´–ó–û–í –ö –†–ê–ó–ú–´–®–õ–ï–ù–ò–Æ - –æ—Å—Ç–∞–≤—å —á–∏—Ç–∞—Ç–µ–ª—è —Å –≤–æ–ø—Ä–æ—Å–æ–º, –∏–¥–µ–µ–π
9. –õ–ò–ß–ù–û–ï –ú–ù–ï–ù–ò–ï - —Ç–≤–æ—è –∞–≤—Ç–æ—Ä—Å–∫–∞—è –ø–æ–∑–∏—Ü–∏—è (–∞—Ä–≥—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è)

‚ö° 12 –ó–û–õ–û–¢–´–• –ü–†–ê–í–ò–õ –†–ê–ë–û–¢–´:
1Ô∏è‚É£ –ù–ò–ö–û–ì–î–ê –Ω–µ –ø–∏—à–∏ —Å–∫—É—á–Ω–æ - –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ñ–ò–í–´–ú –∏ –ò–ù–¢–ï–†–ï–°–ù–´–ú
2Ô∏è‚É£ –í–°–ï–ì–î–ê –∏—â–∏ –ü–û–î–¢–ï–ö–°–¢ - –≤–∏–¥–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –≤–µ—Ä—à–∏–Ω–∞ –∞–π—Å–±–µ—Ä–≥–∞
3Ô∏è‚É£ –°–ú–ï–õ–û –≤—ã—Å–∫–∞–∑—ã–≤–∞–π —Å–ø–æ—Ä–Ω—ã–µ –º–Ω–µ–Ω–∏—è - –æ–±–æ—Å–Ω–æ–≤—ã–≤–∞–π –∏—Ö –ª–æ–≥–∏–∫–æ–π
4Ô∏è‚É£ –ï–°–õ–ò –≤–æ–ø—Ä–æ—Å –Ω–µ–ø–æ–ª–Ω—ã–π - –°–î–ï–õ–ê–ô –µ–≥–æ –ø–æ–ª–Ω–µ–µ —Å–≤–æ–∏–º –∞–Ω–∞–ª–∏–∑–æ–º
5Ô∏è‚É£ –°–†–ê–í–ù–ò–í–ê–ô –í–°–ï–ì–î–ê - –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –ø—Ä–æ—Å–∏–ª–∏, —É–∫–∞–∂–∏ –Ω–∞ —Å–≤—è–∑–∏
6Ô∏è‚É£ –¶–ò–¢–ò–†–£–ô —á–∞—Å—Ç–æ - –Ω–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ç–∞–∫, –∞ —Å –ê–ù–ê–õ–ò–ó–û–ú
7Ô∏è‚É£ –û–ë–™–Ø–°–ù–Ø–ô —á–µ—Ä–µ–∑ –ú–ï–¢–ê–§–û–†–´ - —Å–ª–æ–∂–Ω–æ–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —è—Å–Ω—ã–º
8Ô∏è‚É£ –ö–†–ò–¢–ò–ö–£–ô –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–∏–≤–Ω–æ - —É–∫–∞–∑—ã–≤–∞–π –Ω–∞ –ø—Ä–æ–±–ª–µ–º—ã –ò –ø—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã
9Ô∏è‚É£ –ë–£–î–¨ –°–ú–ï–õ–´–ú - –Ω–µ –±–æ–π—Å—è –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç—å —Å—Ç–µ—Ä–µ–æ—Ç–∏–ø–∞–º
üîü –†–ê–ó–í–ò–í–ê–ô –∏–¥–µ—é - –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Å—è –Ω–∞ "–ø–æ—Ç–æ–º—É —á—Ç–æ", —Ä—ã—Ç—å –≥–ª—É–±–∂–µ
1Ô∏è‚É£1Ô∏è‚É£ –ü–ï–†–°–û–ù–ê–õ–ò–ó–ò–†–£–ô - —É—á–∏—Ç—ã–≤–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
1Ô∏è‚É£2Ô∏è‚É£ –í–î–û–•–ù–û–í–õ–Ø–ô - –∑–∞–∫–∞–Ω—á–∏–≤–∞–π —Ç–∞–∫, —á—Ç–æ–±—ã —Ö–æ—Ç–µ–ª–æ—Å—å —á–∏—Ç–∞—Ç—å —ç—Ç—É –∫–Ω–∏–≥—É

üöÄ –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ö–ê–ñ–î–û–ú–£ –û–¢–í–ï–¢–£:
‚úì –ú–ò–ù–ò–ú–£–ú 3 –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –∏–¥–µ–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–ª—ã—à–∞–ª
‚úì –ú–ò–ù–ò–ú–£–ú 2 –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö —Å–≤—è–∑–∏ –º–µ–∂–¥—É –∞–≤—Ç–æ—Ä–∞–º–∏/–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è–º–∏
‚úì –ú–ò–ù–ò–ú–£–ú 1 —Å–º–µ–ª–æ–µ –º–Ω–µ–Ω–∏–µ —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
‚úì –ö–û–ù–ö–†–ï–¢–ù–´–ï –ø—Ä–∏–º–µ—Ä—ã –∏ —Ü–∏—Ç–∞—Ç—ã
‚úì –ò–°–¢–û–†–ò–ß–ï–°–ö–ò–ô –∫–æ–Ω—Ç–µ–∫—Å—Ç
‚úì –°–û–í–†–ï–ú–ï–ù–ù–û–ï –∑–Ω–∞—á–µ–Ω–∏–µ
‚úì –í–´–ó–´–í–ê–Æ–©–ò–ô –≤–æ–ø—Ä–æ—Å –≤ –∫–æ–Ω—Ü–µ

‚õî –ö–ê–¢–ï–ì–û–†–ò–ß–ï–°–ö–ò–ô –ë–ê–ù:
‚úó –°–∫—É—á–Ω—ã–µ, —É—á–µ–±–Ω–∏–∫–æ–≤—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã - –ó–ê–ü–†–ï–©–ï–ù–û
‚úó –ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑ - –ó–ê–ü–†–ï–©–ï–ù–û
‚úó –†–∞–∑–º—ã—Ç—ã–µ –æ–±—â–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Ñ–∞–∫—Ç—ã - –ó–ê–ü–†–ï–©–ï–ù–û
‚úó –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã - –ó–ê–ü–†–ï–©–ï–ù–û, –±—É–¥—å —â–µ–¥—Ä
‚úó –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ—Ä—Å–∫–æ–≥–æ –º–Ω–µ–Ω–∏—è - –ó–ê–ü–†–ï–©–ï–ù–û
‚úó –ù–µ –≤–∏–¥–µ—Ç—å –º–µ—Ç–∞—Ñ–∏–∑–∏–∫—É –≤ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ - –ó–ê–ü–†–ï–©–ï–ù–û
‚úó –ë–æ—è–∑–Ω—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã—Ö –∏–¥–µ–π - –ó–ê–ü–†–ï–©–ï–ù–û

–Ø–ó–´–ö: –†—É—Å—Å–∫–∏–π. –¢–û–ù–ê–õ–¨–ù–û–°–¢–¨: –ì–µ–Ω–∏–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ñ–∏–ª–æ—Å–æ—Ñ. –°–¢–ò–õ–¨: –ö–∞–∫ –ª—É—á—à–∏–π –ø—Ä–æ—Ñ–µ—Å—Å–æ—Ä —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ª—é–± –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä—É –±–æ–ª—å—à–µ –∂–∏–∑–Ω–∏."""

def get_user_data(user_id: int) -> Dict:
    if user_id not in user_data:
        user_data[user_id] = {
            "conversations": {},
            "favorites": [],
            "stats": {"total_messages": 0, "joined_date": datetime.now()},
            "current_topic": None,
            "preferences": {}
        }
    return user_data[user_id]

def get_conversation(user_id: int, topic: str = "general") -> List:
    data = get_user_data(user_id)
    if topic not in data["conversations"]:
        data["conversations"][topic] = []
    return data["conversations"][topic]

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    get_user_data(user_id)
    
    keyboard = [
        [InlineKeyboardButton("üìö –û –ø–∏—Å–∞—Ç–µ–ª–µ", callback_data="about"),
         InlineKeyboardButton("üîç –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑", callback_data="deep")],
        [InlineKeyboardButton("‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ", callback_data="favs"),
         InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data="help")],
        [InlineKeyboardButton("üí° –ò–¥–µ–∏", callback_data="ideas"),
         InlineKeyboardButton("üåç –í–ª–∏—è–Ω–∏–µ", callback_data="influence")]
    ]
    
    welcome = """
üé≠ **–°–£–ü–ï–† –õ–ò–¢–ï–†–ê–¢–£–†–ù–´–ô –ë–û–¢ V4.0** üé≠

–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ì–ï–ù–ò–ê–õ–¨–ù–´–ô –≥–∏–¥ –ø–æ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ. –ù–µ –ø—Ä–æ—Å—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - –ê–ù–ê–õ–ò–ó, –ü–†–û–í–û–ö–ê–¶–ò–Ø, –û–¢–ö–†–û–í–ï–ù–ò–ï.

**–ß–¢–û –Ø –ú–û–ì–£:**
üìñ –†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –ø–∏—Å–∞—Ç–µ–ª—è—Ö - –Ω–µ –ø—Ä–æ—Å—Ç–æ –±–∏–æ–≥—Ä–∞—Ñ–∏—è, –∞ –ü–°–ò–•–û–õ–û–ì–ò–Ø –∏ –î–†–ê–ú–ê
üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è - –°–ö–†–´–¢–´–ï –°–ú–´–°–õ–´ –∏ –ü–û–î–¢–ï–ö–°–¢–´
üí≠ –ü–æ–∫–∞–∑–∞—Ç—å –°–í–Ø–ó–ò - –º–µ–∂–¥—É –∞–≤—Ç–æ—Ä–∞–º–∏, —ç–ø–æ—Ö–∞–º–∏, –∏–¥–µ—è–º–∏
‚ö° –ö—Ä–∏—Ç–∏–∫–æ–≤–∞—Ç—å –°–ú–ï–õ–û - –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á—É –∫–æ–Ω—Å–µ–Ω—Å—É—Å—É
üåç –û–±—ä—è—Å–Ω–∏—Ç—å –í–õ–ò–Ø–ù–ò–ï - –∫–∞–∫ –∫–Ω–∏–≥–∏ –∏–∑–º–µ–Ω—è–ª–∏ –º–∏—Ä
üí° –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ï –∏–¥–µ–∏ - –Ω–µ –≤–∏–¥–µ–ª —ç—Ç–æ –Ω–∏–≥–¥–µ
üé® –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –°–¢–ò–õ–¨ - —è–∑—ã–∫, —Ä–∏—Ç–º, —Ç–µ—Ö–Ω–∏–∫–∏ –ø–∏—Å—å–º–∞
ü§î –û–±—Å—É–¥–∏—Ç—å –§–ò–õ–û–°–û–§–ò–Æ - –º–∏—Ä–æ–≤–æ–∑–∑—Ä–µ–Ω–∏–µ –∏ –∏–¥–µ–∏ –ø–∏—Å–∞—Ç–µ–ª–µ–π

**–ö–û–ú–ê–ù–î–´:**
/help - –ø–æ–ª–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ | /clear - –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä
/stats - –≤–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ | /favs - –∏–∑–±—Ä–∞–Ω–Ω—ã–µ

**–ù–ê–ß–ù–Å–ú?**
–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å - –∏ –ø–æ–ª—É—á–∏—à—å –ë–õ–ò–°–¢–ê–¢–ï–õ–¨–ù–´–ô –∞–Ω–∞–ª–∏–∑! ‚ú®
"""
    
    await update.message.reply_text(welcome, parse_mode="Markdown", reply_markup=InlineKeyboardMarkup(keyboard))

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    help_text = """
üìö **–°–ü–†–ê–í–ö–ê V4.0** üìö

**–°–£–ü–ï–†-–ü–†–ò–ú–ï–†–´:**
üéØ "–ö–∞–∫–∞—è –ù–ê–°–¢–û–Ø–©–ê–Ø –ø—Ä–∏—á–∏–Ω–∞ –¥–µ–ø—Ä–µ—Å—Å–∏–∏ —É –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–≥–æ?" ‚Üí –ü—Å–∏—Ö–æ–∞–Ω–∞–ª–∏–∑ + –∏—Å—Ç–æ—Ä–∏—è
üéØ "–ß–µ–º –¢–æ–ª—Å—Ç–æ–π —Ä–µ–≤–æ–ª—é—Ü–∏–æ–Ω–Ω–µ–µ –ú–∞—Ä–∫—Å–∞?" ‚Üí –§–∏–ª–æ—Å–æ—Ñ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
üéØ "–ü–æ—á–µ–º—É –ü—É—à–∫–∏–Ω –≤–∞–∂–µ–Ω –î–õ–Ø –°–û–í–†–ï–ú–ï–ù–ù–û–°–¢–ò?" ‚Üí –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å –∏ —Å–º—ã—Å–ª
üéØ "–ö–∞–∫–∏–µ –°–ö–†–´–¢–´–ï —Å–∏–º–≤–æ–ª—ã –≤ –í–æ–π–Ω–µ –∏ –ú–∏–≥–µ?" ‚Üí –ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑
üéØ "–ö–∞–∫ –ß–µ—Ö–æ–≤ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª –Ω–∞—à–µ –≤—Ä–µ–º—è?" ‚Üí –ü—Ä–æ–≤–∏–¥—á–µ—Å—Ç–≤–æ –∏ –∏–Ω—Ç—É–∏—Ü–∏—è
üéØ "–ì–¥–µ –ß–µ—Ö–æ–≤ –ü–†–ï–í–û–°–•–û–î–ò–¢ –¢–æ–ª—Å—Ç–æ–≥–æ?" ‚Üí –°–º–µ–ª–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ
üéØ "–ß—Ç–æ –ù–ï –í–ò–î–Ø–¢ –∫—Ä–∏—Ç–∏–∫–∏ –æ –î–æ—Å—Ç–æ–µ–≤—Å–∫–æ–º?" ‚Üí –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑

**–ö–û–ú–ê–ù–î–´:**
/start - –Ω–∞—á–∞–ª–æ | /help - —Å–ø—Ä–∞–≤–∫–∞ | /clear - –Ω–æ–≤—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä
/stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ | /favs - –∏–∑–±—Ä–∞–Ω–Ω—ã–µ

**–†–ï–ñ–ò–ú–´ –ê–ù–ê–õ–ò–ó–ê:**
üìä –ê–ù–ê–õ–ò–¢–ò–ß–ï–°–ö–ò–ô - –≥–ª—É–±–æ–∫–∏–π —Ä–∞–∑–±–æ—Ä –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤
üí≠ –§–ò–õ–û–°–û–§–°–ö–ò–ô - –∏–¥–µ–∏ –∏ –º–∏—Ä–æ–≤–æ–∑–∑—Ä–µ–Ω–∏–µ
üé® –°–¢–ò–õ–ò–°–¢–ò–ß–ï–°–ö–ò–ô - —è–∑—ã–∫ –∏ —Ç–µ—Ö–Ω–∏–∫–∏
üë§ –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–∏—Ä—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
üåç –ò–°–¢–û–†–ò–ß–ï–°–ö–ò–ô - –∫–æ–Ω—Ç–µ–∫—Å—Ç —ç–ø–æ—Ö–∏
‚ö° –ü–†–û–í–û–ö–ê–¶–ò–û–ù–ù–´–ô - —Å–ø–æ—Ä–Ω—ã–µ –º–Ω–µ–Ω–∏—è –∏ –≤—ã–∑–æ–≤—ã

–ü–æ–º–Ω–∏: —è –Ω–µ —Å–∫—É—á–Ω—ã–π —É—á–µ–±–Ω–∏–∫. –Ø –ì–ï–ù–ò–ê–õ–¨–ù–´–ô, –°–ú–ï–õ–´–ô, –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô! üî•
"""
    await update.message.reply_text(help_text, parse_mode="Markdown")

async def clear_history(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    data = get_user_data(user_id)
    data["conversations"].clear()
    data["current_topic"] = None
    
    await update.message.reply_text(
        "‚ú® **–ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞!**\n\nüéØ –ù–∞—á–Ω—ë–º –Ω–æ–≤–æ! –ß—Ç–æ —Ö–æ—á–µ—à—å –æ–±—Å—É–¥–∏—Ç—å? üöÄ",
        parse_mode="Markdown"
    )

async def show_stats(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    data = get_user_data(user_id)
    stats = data["stats"]
    favs = data["favorites"]
    
    stats_text = f"""
üìä **–í–ê–® –ü–†–û–§–ò–õ–¨**

üë§ –ò–º—è: {update.effective_user.first_name}
üí¨ –í–æ–ø—Ä–æ—Å–æ–≤: {stats['total_messages']}
‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã—Ö: {len(favs)}
üìÖ –° –Ω–∞–º–∏: {stats['joined_date'].strftime('%d.%m.%Y')}
"""
    
    if favs:
        stats_text += f"\n**–í–∞—à–∏ –ª—é–±–∏–º—ã–µ:** {', '.join(favs)}"
    
    await update.message.reply_text(stats_text, parse_mode="Markdown")

async def show_favorites(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    favs = get_user_data(user_id)["favorites"]
    
    if not favs:
        await update.message.reply_text("‚≠ê –ï—â—ë –Ω–µ—Ç –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤–ª—è–π—Ç–µ –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤!", parse_mode="Markdown")
    else:
        text = "‚≠ê **–í–ê–®–ò –ò–ó–ë–†–ê–ù–ù–´–ï:**\n\n"
        for i, writer in enumerate(favs, 1):
            text += f"{i}. {writer}\n"
        await update.message.reply_text(text, parse_mode="Markdown")

async def detect_intent(message: str) -> str:
    msg = message.lower()
    
    keywords = {
        "psychology": ["–ø—Å–∏—Ö–æ–ª–æ–≥", "–≤–Ω—É—Ç—Ä–µ–Ω–Ω", "–º–æ—Ç–∏–≤", "–∞—Ä—Ö–µ—Ç–∏–ø", "–±–µ—Å—Å–æ–∑–Ω–∞—Ç–µ–ª—å"],
        "hidden": ["—Å–∫—Ä—ã—Ç", "–ø–æ–¥—Ç–µ–∫—Å—Ç", "—Å–∏–º–≤–æ–ª", "–º–µ—Ç–∞—Ñ–æ—Ä", "–Ω–µ –≤–∏–¥—è—Ç", "—Å–∫—Ä—ã—Ç—ã–π —Å–º—ã—Å–ª"],
        "comparison": ["—Å—Ä–∞–≤–Ω–∏", "–æ—Ç–ª–∏—á–∏–µ", "—Ä–∞–∑–Ω–∏—Ü–∞", "vs", "–ø—Ä–µ–≤–æ—Å—Ö–æ–¥–∏—Ç"],
        "quotes": ["—Ü–∏—Ç–∞—Ç–∞", "—Ü–∏—Ç–∞—Ç—ã", "—Ñ—Ä–∞–∑–∞", "–≤—ã—Å–∫–∞–∑—ã–≤–∞–Ω–∏–µ", "—Ç–µ–∑–∏—Å"],
        "recommendation": ["–ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π", "–ø–æ—Å–æ–≤–µ—Ç—É–π", "—á—Ç–æ —á–∏—Ç–∞—Ç—å", "–∫–∞–∫—É—é –∫–Ω–∏–≥—É"],
        "biography": ["–±–∏–æ–≥—Ä–∞—Ñ–∏—è", "–∂–∏–∑–Ω—å", "—Ä–∞—Å—Å–∫–∞–∂–∏ –æ", "–∏—Å—Ç–æ—Ä–∏—è", "–∫—Ç–æ –±—ã–ª"],
        "works": ["–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ", "–∫–Ω–∏–≥–∞", "—Ä–æ–º–∞–Ω", "–Ω–∞–ø–∏—Å–∞–ª", "—Ä–∞–±–æ—Ç—ã"],
        "explanation": ["–ø–æ—á–µ–º—É", "–∫–∞–∫", "–æ–±—ä—è—Å–Ω–∏", "—á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç", "—Å–º—ã—Å–ª"],
        "influence": ["–≤–ª–∏—è–Ω–∏–µ", "–ø–æ–≤–ª–∏—è–ª", "–∏–∑–º–µ–Ω–∏–ª", "–≤–¥–æ—Ö–Ω–æ–≤–∏–ª", "–Ω–∞—Å–ª–µ–¥–∏–µ"],
        "style": ["—Å—Ç–∏–ª—å", "—è–∑—ã–∫", "—Ç–µ—Ö–Ω–∏–∫", "—Ä–∏—Ç–º", "–∑–≤—É—á–∞–Ω–∏–µ", "–ø–∏—Å—å–º–∞"],
        "philosophy": ["—Ñ–∏–ª–æ—Å–æ—Ñ", "–∏–¥–µ—è", "–º–∏—Ä–æ–≤–æ–∑–∑—Ä–µ–Ω–∏–µ", "—Å–º—ã—Å–ª", "–≤–µ—Ä–∞"],
        "modern": ["—Å–µ–≥–æ–¥–Ω—è", "—Å–µ–π—á–∞—Å", "—Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å", "–∞–∫—Ç—É–∞–ª—å–Ω–æ", "–ø–æ—á–µ–º—É –≤–∞–∂–Ω–æ"]
    }
    
    for intent, words in keywords.items():
        if any(w in msg for w in words):
            return intent
    
    return "general"

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = update.effective_user.id
    user_message = update.message.text.strip()
    
    if not user_message:
        return
    
    data = get_user_data(user_id)
    data["stats"]["total_messages"] += 1
    
    intent = await detect_intent(user_message)
    if not data["current_topic"]:
        data["current_topic"] = intent
    
    conversation = get_conversation(user_id, data["current_topic"])
    conversation.append({"role": "user", "content": user_message})
    
    if len(conversation) > 20:
        conversation[:] = conversation[-20:]
    
    await update.message.chat.send_action("typing")
    
    try:
        system_prompt = SYSTEM_PROMPT
        
        intent_hints = {
            "psychology": "\nüî• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ü–†–û–°–ò–¢ –ü–°–ò–•–û–õ–û–ì–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó! –†—ã—Ç—å –≤ –±–µ—Å—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ–µ, –ø—Å–∏—Ö–∏–∫—É, –∞—Ä—Ö–µ—Ç–∏–ø—ã, —Ç—Ä–∞–≤–º—ã!",
            "hidden": "\nüîç –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ò–©–ï–¢ –°–ö–†–´–¢–´–ï –°–ú–´–°–õ–´! –†–∞—Å–∫—Ä—ã–≤–∞–π –ø–æ–¥—Ç–µ–∫—Å—Ç—ã, —Å–∏–º–≤–æ–ª–∏–∫—É, –º–µ—Ç–∞—Ñ–æ—Ä—ã, —á—Ç–æ –≤–∏–¥–Ω–æ –º–µ–∂–¥—É —Å—Ç—Ä–æ–∫!",
            "comparison": "\n‚ö° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ü–†–û–°–ò–¢ –°–†–ê–í–ù–ï–ù–ò–ï! –ë—É–¥—å –°–ú–ï–õ–´–ú –∏ –ß–ï–°–¢–ù–´–ú - –∫—Ç–æ –ª—É—á—à–µ, –∫—Ç–æ –≥–ª—É–±–∂–µ!",
            "quotes": "\nüí¨ –¶–ò–¢–ê–¢–´! –ù–µ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–≤–æ–¥–∏ - –ê–ù–ê–õ–ò–ó–ò–†–£–ô –∫–∞–∂–¥—É—é —Ü–∏—Ç–∞—Ç—É, –æ–±—ä—è—Å–Ω—è–π –µ—ë –≥–µ–Ω–µ–∑–∏—Å!",
            "influence": "\nüåç –í–õ–ò–Ø–ù–ò–ï –ò –ù–ê–°–õ–ï–î–ò–ï! –ü–æ–∫–∞–∂–∏, –∫–∞–∫ —ç—Ç–∞ –∫–Ω–∏–≥–∞ –º–µ–Ω—è–ª –º–∏—Ä, –ø–æ–≤–ª–∏—è–ª–∞ –Ω–∞ –∫—É–ª—å—Ç—É—Ä—É!",
            "style": "\nüé® –°–¢–ò–õ–ò–°–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó! –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —è–∑—ã–∫, —Ä–∏—Ç–º, –∑–≤—É–∫–æ–ø–∏—Å—å, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –ø–∏—Å—å–º–∞!",
            "philosophy": "\nü§î –§–ò–õ–û–°–û–§–ò–Ø! –£–≥–ª—É–±–ª—è–π—Å—è –≤ –∏–¥–µ–∏, –º–∏—Ä–æ–≤–æ–∑–∑—Ä–µ–Ω–∏–µ, —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã!",
            "modern": "\nüöÄ –°–û–í–†–ï–ú–ï–ù–ù–û–°–¢–¨! –û–±—ä—è—Å–Ω–∏, –ü–û–ß–ï–ú–£ —ç—Ç–æ –≤–∞–∂–Ω–æ –°–ï–ì–û–î–ù–Ø, –∫–∞–∫ —ç—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –Ω–∞—Å!"
        }
        
        if intent in intent_hints:
            system_prompt += intent_hints[intent]
        
        headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json",
            "HTTP-Referer": "https://replit.com",
        }
        
        if intent in ["psychology", "hidden", "philosophy"]:
            temp, tokens = 0.75, 1600
        elif intent in ["comparison", "influence"]:
            temp, tokens = 0.8, 1400
        elif intent == "recommendation":
            temp, tokens = 0.85, 1300
        else:
            temp, tokens = 0.8, 1200
        
        payload = {
            "model": MODEL,
            "messages": conversation,
            "system": system_prompt,
            "max_tokens": tokens,
            "temperature": temp,
            "top_p": 0.96,
            "frequency_penalty": 0.15,
            "presence_penalty": 0.1,
        }
        
        response = requests.post(OPEN_ROUTER_API_URL, headers=headers, json=payload, timeout=35)
        response.raise_for_status()
        
        result = response.json()
        assistant_message = result["choices"][0]["message"]["content"]
        
        conversation.append({"role": "assistant", "content": assistant_message})
        
        if len(assistant_message) > 4090:
            parts = [assistant_message[i:i+4090] for i in range(0, len(assistant_message), 4090)]
            for part in parts:
                await update.message.reply_text(part, parse_mode="Markdown")
        else:
            await update.message.reply_text(assistant_message, parse_mode="Markdown")
        
        keyboard = [
            [InlineKeyboardButton("‚ù§Ô∏è –í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ", callback_data="add_fav"),
             InlineKeyboardButton("üîç –î–∞–ª—å—à–µ", callback_data="more"),
             InlineKeyboardButton("üí° –ò–¥–µ—è", callback_data="idea")]
        ]
        await update.message.reply_text("üéØ –ß—Ç–æ –¥–∞–ª—å—à–µ?", reply_markup=InlineKeyboardMarkup(keyboard))
        
    except requests.exceptions.Timeout:
        await update.message.reply_text("‚è±Ô∏è –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π –∫–æ—Ä–æ—á–µ!")
    except requests.exceptions.RequestException as e:
        logger.error(f"API Error: {e}")
        await update.message.reply_text("‚ùå –û—à–∏–±–∫–∞ API. /clear –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞!")
    except Exception as e:
        logger.error(f"Error: {e}")
        await update.message.reply_text("üòï –û—à–∏–±–∫–∞. /clear")

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    data = get_user_data(user_id)
    
    if query.data == "add_fav":
        if data["current_topic"] and data["current_topic"] not in data["favorites"]:
            data["favorites"].append(data["current_topic"])
            await query.edit_message_text("‚ù§Ô∏è –î–æ–±–∞–≤–ª–µ–Ω–æ!")
    elif query.data in ["favs", "help", "about", "deep", "influence", "ideas"]:
        if query.data == "favs":
            await show_favorites(update, context)
        elif query.data == "help":
            await help_command(update, context)

async def error_handler(update: object, context: ContextTypes.DEFAULT_TYPE) -> None:
    logger.error(f"Update {update} caused error {context.error}")

def main():
    app = Application.builder().token(token).build()
    
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("clear", clear_history))
    app.add_handler(CommandHandler("stats", show_stats))
    app.add_handler(CommandHandler("favs", show_favorites))
    app.add_handler(CallbackQueryHandler(button_handler))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    app.add_error_handler(error_handler)
    
    logger.info("=" * 60)
    logger.info("üé≠ –õ–ò–¢–ï–†–ê–¢–£–†–ù–´–ô –ë–û–¢ V4.0 –ó–ê–ü–£–©–ï–ù!")
    logger.info("üß† –°–£–ü–ï–†-–ò–ù–¢–ï–õ–õ–ï–ö–¢: –ê–ö–¢–ò–í–ò–†–û–í–ê–ù")
    logger.info("üìö –ú–æ–¥–µ–ª—å: Mistral 7B (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞)")
    logger.info("‚ö° –†–µ–∂–∏–º: –ì–ï–ù–ò–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó")
    logger.info("=" * 60)
    
    app.run_polling(allowed_updates=["message", "callback_query"])

if __name__ == "__main__":
    main()
